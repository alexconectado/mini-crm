{% extends 'crm/base.html' %}
{% load crm_filters %}

{% block title %}Configura√ß√£o do Funil - Admin{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-4" x-data="funilConfig()">
    <!-- Header -->
    <div class="mb-4">
        <h1 class="text-3xl font-bold text-gray-800">‚öôÔ∏è Configura√ß√£o do Funil - MODO VISUAL</h1>
        <p class="text-gray-600 mt-1">Configure TODA a l√≥gica do pipeline pelo frontend - defina para onde cada resultado leva o card!</p>
    </div>

    <!-- Aviso -->
    <div class="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-4 mb-4">
        <p class="text-sm text-purple-900">
            <strong>üéØ NOVA FUNCIONALIDADE:</strong> Agora voc√™ define visualmente para onde o card avan√ßa! 
            Cada resultado pode mover o card para a pr√≥xima etapa que voc√™ configurar.
        </p>
    </div>

    <!-- Abas por coluna (4 ETAPAS) -->
    <div class="space-y-4">
        <!-- Seletores de aba -->
        <div class="flex gap-2 overflow-x-auto pb-2">
            {% for col_key, col_label in colunas.items %}
            <button
                @click="activeColumn = '{{ col_key }}'"
                :class="activeColumn === '{{ col_key }}' ? 'bg-purple-600 text-white shadow-lg scale-105' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'"
                class="px-6 py-3 rounded-lg font-bold whitespace-nowrap transition-all duration-200"
            >
                {{ col_label }}
            </button>
            {% endfor %}
        </div>

        <!-- Conte√∫do por coluna -->
        {% for col_key, col_label in colunas.items %}
        <div x-show="activeColumn === '{{ col_key }}'" x-cloak class="space-y-4">
            <!-- Grid por status do cliente -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                {% for status_key, status_label in status_cliente_choices.items %}
                {% with config=config_data|get_item:col_key|get_item:status_key %}
                <div class="bg-white border-2 border-gray-300 rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition-shadow">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-purple-100 via-blue-100 to-purple-100 p-4 border-b-2 border-gray-300">
                        <h3 class="font-bold text-gray-900 text-lg">{{ status_label }}</h3>
                        <p class="text-sm text-gray-700 mt-1">
                            <span class="bg-green-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">{{ config.resultado_ativos }}</span> 
                            de {{ config.resultado_count }} ativos
                        </p>
                    </div>

                    <!-- RESULTADOS -->
                    <div class="p-4 space-y-2 border-b-2 border-gray-200 max-h-96 overflow-y-auto bg-gradient-to-b from-white to-gray-50">
                        <div class="flex items-center justify-between mb-3">
                            <p class="text-sm font-bold text-gray-800 uppercase tracking-wide">üìã Resultados</p>
                            <button
                                @click="abrirModalCriarResultado('{{ col_key }}', '{{ status_key }}')"
                                class="px-3 py-1.5 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg text-sm font-bold hover:from-green-700 hover:to-green-800 transition shadow-md hover:shadow-lg"
                            >
                                + Adicionar
                            </button>
                        </div>
                        
                        {% for resultado in config.resultados %}
                        <div class="flex items-center gap-2 p-3 rounded-lg border-2 {% if resultado.ativo %}bg-gradient-to-r from-green-50 to-emerald-50 border-green-300{% else %}bg-gray-100 border-gray-300{% endif %} hover:shadow-md transition-all">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-bold text-gray-900 truncate" title="{{ resultado.label }}">
                                    {{ resultado.label }}
                                </p>
                                <p class="text-xs text-gray-600 mt-0.5">
                                    <span class="bg-gray-200 px-1.5 py-0.5 rounded font-mono text-[10px]">{{ resultado.key }}</span>
                                </p>
                                {% if resultado.proxima_coluna and resultado.proxima_coluna != 'manter' %}
                                <p class="text-xs text-purple-700 font-semibold mt-1">
                                    ‚Üí Avan√ßa para: <span class="bg-purple-100 px-2 py-0.5 rounded">{{ resultado.get_proxima_coluna_display }}</span>
                                </p>
                                {% else %}
                                <p class="text-xs text-gray-500 mt-1">
                                    ‚Üí Mant√©m na mesma coluna
                                </p>
                                {% endif %}
                            </div>
                            <div class="flex flex-col gap-1">
                                <button
                                    @click="abrirModalEditarResultado({{ resultado.id }}, '{{ resultado.key }}', '{{ resultado.label }}', '{{ resultado.proxima_coluna|default:'manter' }}')"
                                    class="px-2.5 py-1 bg-blue-100 text-blue-800 hover:bg-blue-200 rounded text-xs font-bold transition shadow-sm"
                                    title="Editar"
                                >
                                    ‚úèÔ∏è
                                </button>
                                <button
                                    @click="toggleResultado({{ resultado.id }})"
                                    :class="!{{ resultado.ativo|lower }} ? 'bg-red-100 text-red-800 hover:bg-red-200' : 'bg-green-100 text-green-800 hover:bg-green-200'"
                                    class="px-2.5 py-1 rounded text-xs font-bold transition shadow-sm"
                                    title="{% if resultado.ativo %}Desativar{% else %}Ativar{% endif %}"
                                >
                                    {% if resultado.ativo %}‚úì{% else %}‚úï{% endif %}
                                </button>
                                <button
                                    @click="confirmarExcluirResultado({{ resultado.id }}, '{{ resultado.label }}')"
                                    class="px-2.5 py-1 bg-red-100 text-red-800 hover:bg-red-200 rounded text-xs font-bold transition shadow-sm"
                                    title="Excluir"
                                >
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <p class="text-sm text-gray-500 font-semibold">Nenhum resultado configurado</p>
                            <p class="text-xs text-gray-400 mt-1">Clique em "+ Adicionar" para criar</p>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- PR√ìXIMOS PASSOS -->
                    <div class="p-4 space-y-2 max-h-64 overflow-y-auto bg-gradient-to-b from-gray-50 to-white">
                        <div class="flex items-center justify-between mb-3">
                            <p class="text-sm font-bold text-gray-800 uppercase tracking-wide">üìÖ Pr√≥ximos Passos</p>
                            <button
                                @click="abrirModalCriarPasso('{{ col_key }}', '{{ status_key }}')"
                                class="px-3 py-1.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg text-sm font-bold hover:from-blue-700 hover:to-blue-800 transition shadow-md hover:shadow-lg"
                            >
                                + Adicionar
                            </button>
                        </div>
                        
                        {% for passo in config.passos %}
                        <div class="flex items-center gap-2 p-2.5 rounded-lg border-2 {% if passo.ativo %}bg-gradient-to-r from-blue-50 to-sky-50 border-blue-300{% else %}bg-gray-100 border-gray-300{% endif %} hover:shadow-md transition-all">
                            <p class="text-sm font-semibold text-gray-900 truncate flex-1" title="{{ passo.label }}">
                                {{ passo.label }}
                            </p>
                            <div class="flex gap-1">
                                <button
                                    @click="abrirModalEditarPasso({{ passo.id }}, '{{ passo.label }}')"
                                    class="px-2 py-1 bg-blue-100 text-blue-800 hover:bg-blue-200 rounded text-xs font-bold transition"
                                >
                                    ‚úèÔ∏è
                                </button>
                                <button
                                    @click="togglePasso({{ passo.id }})"
                                    :class="!{{ passo.ativo|lower }} ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'"
                                    class="px-2 py-1 rounded text-xs font-bold transition"
                                >
                                    {% if passo.ativo %}‚úì{% else %}‚úï{% endif %}
                                </button>
                                <button
                                    @click="confirmarExcluirPasso({{ passo.id }}, '{{ passo.label }}')"
                                    class="px-2 py-1 bg-red-100 text-red-800 hover:bg-red-200 rounded text-xs font-bold transition"
                                >
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-6 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <p class="text-xs text-gray-500">Nenhum passo configurado</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- MODAL CRIAR RESULTADO -->
    <div x-show="modalCriarResultado" x-cloak class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" @click.self="modalCriarResultado = false">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8">
            <h3 class="text-2xl font-bold mb-6 text-purple-900">‚ûï Adicionar Resultado</h3>
            <form @submit.prevent="criarResultado">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-800 mb-2">Chave (key)</label>
                        <input type="text" x-model="formResultado.key" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="ex: falar_com_responsavel">
                        <p class="text-xs text-gray-500 mt-1">Identificador √∫nico (sem espa√ßos)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-800 mb-2">Label (exibi√ß√£o)</label>
                        <input type="text" x-model="formResultado.label" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="ex: Falar com representante">
                        <p class="text-xs text-gray-500 mt-1">Texto que aparece para o vendedor</p>
                    </div>
                    <div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-4">
                        <label class="block text-sm font-bold text-purple-900 mb-2">üéØ Pr√≥xima Coluna (Avan√ßo do Card)</label>
                        <select x-model="formResultado.proxima_coluna" class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white font-semibold">
                            <option value="manter">‚è∏Ô∏è Manter na mesma coluna</option>
                            <option value="lead">üìå Lead</option>
                            <option value="conta_para_contato">üìû Conta para Contato</option>
                            <option value="negociacao_cotacao">üíº Negocia√ß√£o / Cota√ß√£o</option>
                            <option value="conta_ativa">‚úÖ Conta Ativa</option>
                            <option value="arquivado">üì¶ Arquivado</option>
                        </select>
                        <p class="text-xs text-purple-700 mt-2 font-semibold">‚ö° Quando o vendedor escolher este resultado, o card avan√ßar√° automaticamente!</p>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-lg font-bold hover:from-green-700 hover:to-green-800 transition shadow-lg">Criar</button>
                    <button type="button" @click="modalCriarResultado = false" class="flex-1 bg-gray-200 text-gray-800 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL EDITAR RESULTADO -->
    <div x-show="modalEditarResultado" x-cloak class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" @click.self="modalEditarResultado = false">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8">
            <h3 class="text-2xl font-bold mb-6 text-purple-900">‚úèÔ∏è Editar Resultado</h3>
            <form @submit.prevent="editarResultado">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-800 mb-2">Chave (key)</label>
                        <input type="text" x-model="formResultado.key" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-800 mb-2">Label (exibi√ß√£o)</label>
                        <input type="text" x-model="formResultado.label" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-4">
                        <label class="block text-sm font-bold text-purple-900 mb-2">üéØ Pr√≥xima Coluna (Avan√ßo do Card)</label>
                        <select x-model="formResultado.proxima_coluna" class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white font-semibold">
                            <option value="manter">‚è∏Ô∏è Manter na mesma coluna</option>
                            <option value="lead">üìå Lead</option>
                            <option value="conta_para_contato">üìû Conta para Contato</option>
                            <option value="negociacao_cotacao">üíº Negocia√ß√£o / Cota√ß√£o</option>
                            <option value="conta_ativa">‚úÖ Conta Ativa</option>
                            <option value="arquivado">üì¶ Arquivado</option>
                        </select>
                        <p class="text-xs text-purple-700 mt-2 font-semibold">‚ö° Quando o vendedor escolher este resultado, o card avan√ßar√° automaticamente!</p>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-lg font-bold hover:from-blue-700 hover:to-blue-800 transition shadow-lg">Salvar</button>
                    <button type="button" @click="modalEditarResultado = false" class="flex-1 bg-gray-200 text-gray-800 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL CRIAR PASSO -->
    <div x-show="modalCriarPasso" x-cloak class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" @click.self="modalCriarPasso = false">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8">
            <h3 class="text-2xl font-bold mb-6 text-blue-900">‚ûï Adicionar Pr√≥ximo Passo</h3>
            <form @submit.prevent="criarPasso">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-800 mb-2">Label</label>
                        <input type="text" x-model="formPasso.label" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ex: Ligar novamente amanh√£">
                        <p class="text-xs text-gray-500 mt-1">Descri√ß√£o do pr√≥ximo passo (apenas informativo)</p>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-lg font-bold hover:from-green-700 hover:to-green-800 transition shadow-lg">Criar</button>
                    <button type="button" @click="modalCriarPasso = false" class="flex-1 bg-gray-200 text-gray-800 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL EDITAR PASSO -->
    <div x-show="modalEditarPasso" x-cloak class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" @click.self="modalEditarPasso = false">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8">
            <h3 class="text-2xl font-bold mb-6 text-blue-900">‚úèÔ∏è Editar Pr√≥ximo Passo</h3>
            <form @submit.prevent="editarPasso">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-800 mb-2">Label</label>
                        <input type="text" x-model="formPasso.label" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-lg font-bold hover:from-blue-700 hover:to-blue-800 transition shadow-lg">Salvar</button>
                    <button type="button" @click="modalEditarPasso = false" class="flex-1 bg-gray-200 text-gray-800 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Informa√ß√µes √∫teis -->
    <div class="mt-8 bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-300 rounded-xl p-6 shadow-lg">
        <h3 class="font-bold text-purple-900 mb-3 text-lg">üöÄ COMO FUNCIONA O MODO VISUAL</h3>
        <ul class="text-sm text-purple-900 space-y-2">
            <li class="flex items-start gap-2">
                <span class="text-purple-600 font-bold">‚Üí</span>
                <span><strong>4 ETAPAS:</strong> Lead ‚Üí Conta para Contato ‚Üí Negocia√ß√£o/Cota√ß√£o ‚Üí Conta Ativa</span>
            </li>
            <li class="flex items-start gap-2">
                <span class="text-purple-600 font-bold">‚Üí</span>
                <span><strong>Pr√≥xima Coluna:</strong> Defina para onde o card avan√ßa ao escolher cada resultado!</span>
            </li>
            <li class="flex items-start gap-2">
                <span class="text-purple-600 font-bold">‚Üí</span>
                <span><strong>Manter:</strong> Se escolher "Manter na mesma coluna", o card N√ÉO se move</span>
            </li>
            <li class="flex items-start gap-2">
                <span class="text-purple-600 font-bold">‚Üí</span>
                <span><strong>Arquivar:</strong> Pode configurar resultado para enviar direto ao arquivado</span>
            </li>
            <li class="flex items-start gap-2">
                <span class="text-purple-600 font-bold">‚Üí</span>
                <span>Pr√≥ximo passo √© apenas informativo - N√ÉO move card</span>
            </li>
            <li class="flex items-start gap-2">
                <span class="text-purple-600 font-bold">‚Üí</span>
                <span>Altera√ß√µes s√£o aplicadas imediatamente (cache invalidado automaticamente)</span>
            </li>
        </ul>
    </div>
</div>

<script>
    function funilConfig() {
        return {
            activeColumn: 'lead',
            modalCriarResultado: false,
            modalEditarResultado: false,
            modalCriarPasso: false,
            modalEditarPasso: false,
            formResultado: { id: null, coluna: '', status: '', key: '', label: '', proxima_coluna: 'manter' },
            formPasso: { id: null, coluna: '', status: '', label: '' },

            abrirModalCriarResultado(coluna, status) {
                this.formResultado = { id: null, coluna, status, key: '', label: '', proxima_coluna: 'manter' };
                this.modalCriarResultado = true;
            },

            abrirModalEditarResultado(id, key, label, proxima_coluna) {
                this.formResultado = { id, key, label, proxima_coluna: proxima_coluna || 'manter' };
                this.modalEditarResultado = true;
            },

            abrirModalCriarPasso(coluna, status) {
                this.formPasso = { id: null, coluna, status, label: '' };
                this.modalCriarPasso = true;
            },

            abrirModalEditarPasso(id, label) {
                this.formPasso = { id, label };
                this.modalEditarPasso = true;
            },

            async criarResultado() {
                try {
                    const formData = new FormData();
                    formData.append('coluna_pipeline', this.formResultado.coluna);
                    formData.append('status_cliente', this.formResultado.status);
                    formData.append('key', this.formResultado.key);
                    formData.append('label', this.formResultado.label);
                    formData.append('proxima_coluna', this.formResultado.proxima_coluna);

                    const response = await fetch('/crm/api/admin/criar-resultado/', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() },
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Resultado criado com sucesso!');
                        location.reload();
                    } else {
                        alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                    }
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            async editarResultado() {
                try {
                    const formData = new FormData();
                    formData.append('key', this.formResultado.key);
                    formData.append('label', this.formResultado.label);
                    formData.append('proxima_coluna', this.formResultado.proxima_coluna);

                    const response = await fetch(`/crm/api/admin/editar-resultado/${this.formResultado.id}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() },
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Resultado atualizado com sucesso!');
                        location.reload();
                    } else {
                        alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                    }
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            async confirmarExcluirResultado(id, label) {
                if (!confirm(`‚ö†Ô∏è Confirma exclus√£o de "${label}"?\n\nN√ÉO afeta registros j√° salvos.`)) return;

                try {
                    const response = await fetch(`/crm/api/admin/excluir-resultado/${id}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() }
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Resultado exclu√≠do com sucesso!');
                        location.reload();
                    } else {
                        alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                    }
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            async criarPasso() {
                try {
                    const formData = new FormData();
                    formData.append('coluna_pipeline', this.formPasso.coluna);
                    formData.append('status_cliente', this.formPasso.status);
                    formData.append('label', this.formPasso.label);

                    const response = await fetch('/crm/api/admin/criar-passo/', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() },
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Pr√≥ximo passo criado com sucesso!');
                        location.reload();
                    } else {
                        alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                    }
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            async editarPasso() {
                try {
                    const formData = new FormData();
                    formData.append('label', this.formPasso.label);

                    const response = await fetch(`/crm/api/admin/editar-passo/${this.formPasso.id}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() },
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Pr√≥ximo passo atualizado com sucesso!');
                        location.reload();
                    } else {
                        alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                    }
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            async confirmarExcluirPasso(id, label) {
                if (!confirm(`‚ö†Ô∏è Confirma exclus√£o de "${label}"?`)) return;

                try {
                    const response = await fetch(`/crm/api/admin/excluir-passo/${id}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() }
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Pr√≥ximo passo exclu√≠do com sucesso!');
                        location.reload();
                    } else {
                        alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                    }
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            async toggleResultado(id) {
                try {
                    const response = await fetch(`/crm/api/admin/toggle-resultado-ativo/${id}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() }
                    });
                    const data = await response.json();
                    if (data.success) location.reload();
                    else alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            async togglePasso(id) {
                try {
                    const response = await fetch(`/crm/api/admin/toggle-passo-ativo/${id}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() }
                    });
                    const data = await response.json();
                    if (data.success) location.reload();
                    else alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            getCsrfToken() {
                return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
            }
        }
    }
</script>
{% endblock %}
