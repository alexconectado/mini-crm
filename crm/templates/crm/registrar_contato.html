{% extends 'crm/base.html' %}

{% block title %}Registrar Contato - Mini-CRM{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto p-4">
    <div class="grid grid-cols-3 gap-4">
        <!-- COLUNA ESQUERDA: Formulário -->
        <div class="col-span-2 space-y-4">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Registrar Contato</h2>
                </div>
                
                <!-- Informações do Registro - Compacto -->
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-3 mb-4 border border-blue-200 space-y-3">
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="space-y-1">
                            <p class="text-[11px] uppercase tracking-wide text-gray-500">Empresa</p>
                            <p class="font-bold text-gray-900">{{ registro.nome_empresa }}</p>
                            <p class="text-gray-700 flex items-center gap-2">
                                <i class="fa-solid fa-location-dot text-gray-500"></i>
                                <span>{{ registro.cidade }}/{{ registro.uf }}</span>
                            </p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-[11px] uppercase tracking-wide text-gray-500">Contato</p>
                            <p class="font-semibold text-gray-800 flex items-center gap-2">
                                <i class="fa-solid fa-phone text-gray-500"></i>
                                <span>{{ registro.telefone }}</span>
                            </p>
                            <div class="inline-flex items-center gap-2 px-2 py-1 rounded bg-white border border-blue-100 text-blue-700 font-semibold">
                                <i class="fa-solid fa-headset"></i>
                                <span>{{ registro.get_canal_contato_display }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="space-y-1">
                            <p class="text-[11px] uppercase tracking-wide text-gray-500">Origem</p>
                            <p class="font-semibold text-gray-800 flex items-center gap-2">
                                <i class="fa-solid fa-sitemap text-gray-500"></i>
                                <span>{{ registro.get_origem_display }}</span>
                            </p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-[11px] uppercase tracking-wide text-gray-500">Status atual</p>
                            <p class="font-semibold flex items-center gap-2" style="color: var(--primary);">
                                <i class="fa-solid fa-diagram-project"></i>
                                <span id="status_atual_label">{{ registro.get_status_pipeline_display }}</span>
                            </p>
                        </div>
                    </div>
                </div>

                {% if error %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                    {{ error }}
                </div>
                {% endif %}

                <!-- Dados JSON para Alpine (forma canônica) -->
                <script id="results-data" type="application/json">
                {{ results_json|safe }}
                </script>
                <script id="checklist-data" type="application/json">
                {{ checklist_json|safe }}
                </script>

                <!-- Formulário -->
                <form method="post" class="space-y-4" x-data="{ 
                    results: JSON.parse(document.getElementById('results-data').textContent),
                    checklist: JSON.parse(document.getElementById('checklist-data').textContent),
                    resultado: '',
                    proximoStatusPreview: '',
                    precisaAgendamento: false,
                    get podeSalvar() { return this.resultado !== ''; }
                }">
                    {% csrf_token %}
                    
                    <div>
                        <label for="resultado" class="block text-sm font-medium text-gray-700 mb-2">
                            Resultado (lista fechada) *
                        </label>
                        <select 
                            name="resultado"
                            id="resultado"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            x-model="resultado"
                            @change="
                                const found = results.find(r => r.key === resultado);
                                proximoStatusPreview = found ? found.next_status_label : '';
                                // Mostrar campo de data para resultados que exigem follow-up
                                precisaAgendamento = ['retornar_depois', 'aguardando_resposta', 'avaliando', 'em_negociacao'].includes(resultado);
                            "
                        >
                            <option value="">-- Selecione --</option>
                            <template x-for="item in results" :key="item.key">
                                <option :value="item.key" x-text="item.label"></option>
                            </template>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Sem texto livre. O sistema decide o próximo estágio.</p>
                    </div>

                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <p class="text-sm text-gray-700"><strong>Próximo status (automático):</strong> <span x-text="proximoStatusPreview || 'Definido pelas regras. Avanço exige checklist completo.'"></span></p>
                        <p class="text-xs text-gray-500 mt-1">Definido pelas regras. Avanço exige checklist completo.</p>
                    <!-- Campo condicional: Data/hora de retorno -->
                    <div x-show="precisaAgendamento" x-cloak>
                        <label for="proximo_passo" class="block text-sm font-medium text-gray-700 mb-2">
                            Quando retornar? *
                        </label>
                        <input 
                            type="datetime-local" 
                            name="data_retorno"
                            id="data_retorno"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            :required="precisaAgendamento"
                        >
                        <p class="text-xs text-gray-500 mt-1">Defina data e hora para o próximo contato.</p>
                    </div>

                    <!-- Observações opcionais (sempre visível, não obrigatório) -->
                    <div>
                        <label for="proximo_passo" class="block text-sm font-medium text-gray-700 mb-2">
                            Observações / Próximo passo
                        </label>
                        <textarea 
                            name="proximo_passo"
                            id="proximo_passo"
                            rows="2"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Ex: Cliente pediu proposta formal, enviar por e-mail"
                        ></textarea>
                        <p class="text-xs text-gray-500 mt-1">Contexto livre para consulta futura (opcional).</p>
                    </div>

                    </div>

                    <div x-show="checklist.length" x-cloak>
                        <p class="block text-sm font-medium text-gray-700 mb-2">Checklist do estágio</p>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg divide-y divide-gray-200">
                            <template x-for="item in checklist" :key="item[0]">
                                <label class="flex items-center gap-2 px-3 py-2 text-sm text-gray-800">
                                    <input type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded" name="checklist" :value="item[0]">
                                    <span x-text="item[1]"></span>
                                </label>
                            </template>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Selecione o que já foi executado (parcial permitido).</p>
                    </div>

                    <!-- Próximo passo removido: sistema decide via regras -->

                    <div>
                        <label for="canal_contato" class="block text-sm font-medium text-gray-700 mb-2">
                            Canal do contato *</n                    </label>
                        <select 
                            name="canal_contato"
                            id="canal_contato"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            {% for canal_key, canal_label in canal_choices %}
                            <option value="{{ canal_key }}" {% if registro.canal_contato == canal_key %}selected{% endif %}>{{ canal_label }}</option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Escolha o canal utilizado neste contato.</p>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button 
                            type="submit"
                            class="flex-1 btn-primary"
                            :disabled="!podeSalvar"
                        >
                            <span class="inline-flex items-center gap-2 justify-center"><i class="fa-solid fa-check"></i>Salvar Contato</span>
                        </button>
                        <a 
                            href="{% url 'kanban' %}"
                            class="flex-1 btn-secondary text-center">
                            Voltar
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- COLUNA DIREITA: Histórico de Contatos -->
        <div class="col-span-1">
            <div class="bg-white rounded-lg shadow p-4">
                <h3 class="font-bold text-lg text-gray-800 mb-4 pb-3 border-b border-gray-200 flex items-center gap-2">
                    <i class="fa-regular fa-clock text-gray-600"></i>
                    <span>Histórico</span>
                    {% if registro.historico_contatos.all %}
                    <span class="text-sm text-gray-500 font-normal">({{ registro.historico_contatos.all|length }})</span>
                    {% endif %}
                </h3>
                
                {% if registro.historico_contatos.all %}
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    {% for contato in registro.historico_contatos.all|dictsortreversed:"data_contato" %}
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg p-3 border-l-4 border-blue-500 text-sm hover:shadow transition">
                        <div class="flex items-start justify-between gap-2 mb-2">
                            <div class="inline-flex items-center gap-2 text-xs text-gray-700 font-semibold">
                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-700">{{ forloop.revcounter }}</span>
                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-white border border-blue-100 text-blue-700">
                                    <i class="fa-solid fa-headset"></i>
                                    <span>{{ contato.get_canal_contato_display }}</span>
                                </span>
                            </div>
                            <div class="text-xs text-gray-600 text-right">
                                <div class="bg-white px-2 py-1 rounded inline-flex items-center gap-2">
                                    <span>{{ contato.get_status_anterior_display }} → {{ contato.get_status_novo_display }}</span>
                                    <span class="text-gray-400">|</span>
                                    <span class="text-gray-700">{{ contato.data_contato|date:"d/m H:i" }}</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-gray-700 text-xs mt-2 line-clamp-3">{{ contato.resultado }}</p>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="flex items-center justify-center py-12 text-gray-400">
                    <p class="text-sm">Nenhum contato registrado ainda</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

<script>
// Nenhuma lógica aqui - tudo é declarativo no x-data
</script>
