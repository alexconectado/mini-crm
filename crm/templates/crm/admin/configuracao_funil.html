{% extends 'crm/base.html' %}
{% load crm_filters %}

{% block title %}Configura√ß√£o do Funil - Admin{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-4" x-data="funilConfig()">
    <!-- Header -->
    <div class="mb-4">
        <h1 class="text-3xl font-bold text-gray-800">‚öôÔ∏è Configura√ß√£o do Funil</h1>
        <p class="text-gray-600 mt-1">Gerencie op√ß√µes de resultado e pr√≥ximos passos por etapa e status do cliente</p>
    </div>

    <!-- Aviso de seguran√ßa -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
        <p class="text-sm text-yellow-800">
            <strong>‚ö†Ô∏è Admin only:</strong> Altera√ß√µes aqui afetam o formul√°rio de registro de contato. O pipeline autom√°tico continua intacto.
        </p>
    </div>

    <!-- Abas por coluna (4 ETAPAS) -->
    <div class="space-y-4">
        <!-- Seletores de aba -->
        <div class="flex gap-2 overflow-x-auto pb-2">
            {% for col_key, col_label in colunas.items %}
            <button
                @click="activeColumn = '{{ col_key }}'"
                :class="activeColumn === '{{ col_key }}' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'"
                class="px-4 py-2 rounded-lg font-medium whitespace-nowrap transition"
            >
                {{ col_label }}
            </button>
            {% endfor %}
        </div>

        <!-- Conte√∫do por coluna -->
        {% for col_key, col_label in colunas.items %}
        <div x-show="activeColumn === '{{ col_key }}'" x-cloak class="space-y-4">
            <!-- Grid por status do cliente -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                {% for status_key, status_label in status_cliente_choices.items %}
                {% with config=config_data|get_item:col_key|get_item:status_key %}
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-3 border-b border-gray-200">
                        <h3 class="font-bold text-gray-800">{{ status_label }}</h3>
                        <p class="text-xs text-gray-600 mt-1">
                            {{ config.resultado_ativos }} / {{ config.resultado_count }} resultados ativos
                        </p>
                    </div>

                    <!-- RESULTADOS -->
                    <div class="p-3 space-y-2 border-b border-gray-100 max-h-80 overflow-y-auto">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-xs font-semibold text-gray-700 uppercase tracking-wide">Resultados</p>
                            <button
                                @click="abrirModalCriarResultado('{{ col_key }}', '{{ status_key }}')"
                                class="px-2 py-1 bg-green-600 text-white rounded text-xs font-semibold hover:bg-green-700 transition"
                            >
                                + Adicionar
                            </button>
                        </div>
                        
                        {% for resultado in config.resultados %}
                        <div class="flex items-center gap-2 p-2 rounded {% if resultado.ativo %}bg-green-50 border border-green-200{% else %}bg-gray-50 border border-gray-200{% endif %}">
                            <div class="flex-1 min-w-0">
                                <p class="text-xs font-medium text-gray-800 truncate" title="{{ resultado.label }}">
                                    {{ resultado.label }}
                                </p>
                                <p class="text-[10px] text-gray-600">{{ resultado.key }} ‚Üí {{ resultado.next_status_label|default:"--" }}</p>
                            </div>
                            <div class="flex gap-1">
                                <button
                                    @click="abrirModalEditarResultado({{ resultado.id }}, '{{ resultado.key }}', '{{ resultado.label }}', '{{ resultado.next_status_label }}')"
                                    class="px-2 py-1 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded text-xs font-semibold transition"
                                    title="Editar"
                                >
                                    ‚úèÔ∏è
                                </button>
                                <button
                                    @click="toggleResultado({{ resultado.id }})"
                                    :class="!{{ resultado.ativo|lower }} ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-green-100 text-green-700 hover:bg-green-200'"
                                    class="px-2 py-1 rounded text-xs font-semibold transition"
                                    title="{% if resultado.ativo %}Desativar{% else %}Ativar{% endif %}"
                                >
                                    {% if resultado.ativo %}‚úì{% else %}‚úï{% endif %}
                                </button>
                                <button
                                    @click="confirmarExcluirResultado({{ resultado.id }}, '{{ resultado.label }}')"
                                    class="px-2 py-1 bg-red-100 text-red-700 hover:bg-red-200 rounded text-xs font-semibold transition"
                                    title="Excluir"
                                >
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-xs text-gray-500 italic">Nenhum resultado configurado</p>
                        {% endfor %}
                    </div>

                    <!-- PR√ìXIMOS PASSOS -->
                    <div class="p-3 space-y-2 max-h-60 overflow-y-auto">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-xs font-semibold text-gray-700 uppercase tracking-wide">Pr√≥ximos Passos</p>
                            <button
                                @click="abrirModalCriarPasso('{{ col_key }}', '{{ status_key }}')"
                                class="px-2 py-1 bg-green-600 text-white rounded text-xs font-semibold hover:bg-green-700 transition"
                            >
                                + Adicionar
                            </button>
                        </div>
                        
                        {% for passo in config.passos %}
                        <div class="flex items-center gap-2 p-2 rounded {% if passo.ativo %}bg-blue-50 border border-blue-200{% else %}bg-gray-50 border border-gray-200{% endif %}">
                            <p class="text-xs font-medium text-gray-800 truncate flex-1" title="{{ passo.label }}">
                                {{ passo.label }}
                            </p>
                            <div class="flex gap-1">
                                <button
                                    @click="abrirModalEditarPasso({{ passo.id }}, '{{ passo.label }}')"
                                    class="px-2 py-1 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded text-xs font-semibold transition"
                                    title="Editar"
                                >
                                    ‚úèÔ∏è
                                </button>
                                <button
                                    @click="togglePasso({{ passo.id }})"
                                    :class="!{{ passo.ativo|lower }} ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'"
                                    class="px-2 py-1 rounded text-xs font-semibold transition"
                                    title="{% if passo.ativo %}Desativar{% else %}Ativar{% endif %}"
                                >
                                    {% if passo.ativo %}‚úì{% else %}‚úï{% endif %}
                                </button>
                                <button
                                    @click="confirmarExcluirPasso({{ passo.id }}, '{{ passo.label }}')"
                                    class="px-2 py-1 bg-red-100 text-red-700 hover:bg-red-200 rounded text-xs font-semibold transition"
                                    title="Excluir"
                                >
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-xs text-gray-500 italic">Nenhum pr√≥ximo passo configurado</p>
                        {% endfor %}
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- MODAL CRIAR RESULTADO -->
    <div x-show="modalCriarResultado" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="modalCriarResultado = false">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6">
            <h3 class="text-lg font-bold mb-4">‚ûï Adicionar Resultado</h3>
            <form @submit.prevent="criarResultado">
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Chave (key)</label>
                        <input type="text" x-model="formResultado.key" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ex: falar_com_representante">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Label (exibi√ß√£o)</label>
                        <input type="text" x-model="formResultado.label" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ex: Falar com representante">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pr√≥ximo status (opcional)</label>
                        <input type="text" x-model="formResultado.next_status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ex: Agendado">
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">Criar</button>
                    <button type="button" @click="modalCriarResultado = false" class="flex-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL EDITAR RESULTADO -->
    <div x-show="modalEditarResultado" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="modalEditarResultado = false">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6">
            <h3 class="text-lg font-bold mb-4">‚úèÔ∏è Editar Resultado</h3>
            <form @submit.prevent="editarResultado">
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Chave (key)</label>
                        <input type="text" x-model="formResultado.key" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Label (exibi√ß√£o)</label>
                        <input type="text" x-model="formResultado.label" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pr√≥ximo status (opcional)</label>
                        <input type="text" x-model="formResultado.next_status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Salvar</button>
                    <button type="button" @click="modalEditarResultado = false" class="flex-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL CRIAR PASSO -->
    <div x-show="modalCriarPasso" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="modalCriarPasso = false">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6">
            <h3 class="text-lg font-bold mb-4">‚ûï Adicionar Pr√≥ximo Passo</h3>
            <form @submit.prevent="criarPasso">
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Label</label>
                        <input type="text" x-model="formPasso.label" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ex: Ligar novamente amanh√£">
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">Criar</button>
                    <button type="button" @click="modalCriarPasso = false" class="flex-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL EDITAR PASSO -->
    <div x-show="modalEditarPasso" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="modalEditarPasso = false">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6">
            <h3 class="text-lg font-bold mb-4">‚úèÔ∏è Editar Pr√≥ximo Passo</h3>
            <form @submit.prevent="editarPasso">
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Label</label>
                        <input type="text" x-model="formPasso.label" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Salvar</button>
                    <button type="button" @click="modalEditarPasso = false" class="flex-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Informa√ß√µes √∫teis -->
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h3 class="font-bold text-blue-900 mb-2">üìå Notas Importantes</h3>
        <ul class="text-sm text-blue-800 space-y-1">
            <li>‚Ä¢ <strong>4 ETAPAS:</strong> Lead ‚Üí Conta para Contato ‚Üí Negocia√ß√£o/Cota√ß√£o ‚Üí Conta Ativa</li>
            <li>‚Ä¢ Desativar um resultado/passo remove do formul√°rio, mas n√£o afeta registros j√° salvos</li>
            <li>‚Ä¢ O pipeline autom√°tico continua intacto (n√£o muda com essa config)</li>
            <li>‚Ä¢ Pr√≥ximo passo √© apenas informativo - N√ÉO move card</li>
            <li>‚Ä¢ Altera√ß√µes s√£o aplicadas imediatamente (cache invalidado automaticamente)</li>
        </ul>
    </div>
</div>

<script>
    function funilConfig() {
        return {
            activeColumn: 'lead',
            modalCriarResultado: false,
            modalEditarResultado: false,
            modalCriarPasso: false,
            modalEditarPasso: false,
            formResultado: { id: null, coluna: '', status: '', key: '', label: '', next_status: '' },
            formPasso: { id: null, coluna: '', status: '', label: '' },

            abrirModalCriarResultado(coluna, status) {
                this.formResultado = { id: null, coluna, status, key: '', label: '', next_status: '' };
                this.modalCriarResultado = true;
            },

            abrirModalEditarResultado(id, key, label, next_status) {
                this.formResultado = { id, key, label, next_status };
                this.modalEditarResultado = true;
            },

            abrirModalCriarPasso(coluna, status) {
                this.formPasso = { id: null, coluna, status, label: '' };
                this.modalCriarPasso = true;
            },

            abrirModalEditarPasso(id, label) {
                this.formPasso = { id, label };
                this.modalEditarPasso = true;
            },

            async criarResultado() {
                try {
                    const formData = new FormData();
                    formData.append('coluna_pipeline', this.formResultado.coluna);
                    formData.append('status_cliente', this.formResultado.status);
                    formData.append('key', this.formResultado.key);
                    formData.append('label', this.formResultado.label);
                    formData.append('next_status', this.formResultado.next_status);

                    const response = await fetch('/crm/api/admin/criar-resultado/', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() },
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Resultado criado com sucesso!');
                        location.reload();
                    } else {
                        alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                    }
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            async editarResultado() {
                try {
                    const formData = new FormData();
                    formData.append('key', this.formResultado.key);
                    formData.append('label', this.formResultado.label);
                    formData.append('next_status', this.formResultado.next_status);

                    const response = await fetch(`/crm/api/admin/editar-resultado/${this.formResultado.id}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() },
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Resultado atualizado com sucesso!');
                        location.reload();
                    } else {
                        alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                    }
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            async confirmarExcluirResultado(id, label) {
                if (!confirm(`‚ö†Ô∏è Confirma exclus√£o de "${label}"?\n\nN√ÉO afeta registros j√° salvos.`)) return;

                try {
                    const response = await fetch(`/crm/api/admin/excluir-resultado/${id}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() }
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Resultado exclu√≠do com sucesso!');
                        location.reload();
                    } else {
                        alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                    }
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            async criarPasso() {
                try {
                    const formData = new FormData();
                    formData.append('coluna_pipeline', this.formPasso.coluna);
                    formData.append('status_cliente', this.formPasso.status);
                    formData.append('label', this.formPasso.label);

                    const response = await fetch('/crm/api/admin/criar-passo/', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() },
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Pr√≥ximo passo criado com sucesso!');
                        location.reload();
                    } else {
                        alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                    }
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            async editarPasso() {
                try {
                    const formData = new FormData();
                    formData.append('label', this.formPasso.label);

                    const response = await fetch(`/crm/api/admin/editar-passo/${this.formPasso.id}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() },
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Pr√≥ximo passo atualizado com sucesso!');
                        location.reload();
                    } else {
                        alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                    }
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            async confirmarExcluirPasso(id, label) {
                if (!confirm(`‚ö†Ô∏è Confirma exclus√£o de "${label}"?`)) return;

                try {
                    const response = await fetch(`/crm/api/admin/excluir-passo/${id}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() }
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Pr√≥ximo passo exclu√≠do com sucesso!');
                        location.reload();
                    } else {
                        alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                    }
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            async toggleResultado(id) {
                try {
                    const response = await fetch(`/crm/api/admin/toggle-resultado-ativo/${id}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() }
                    });
                    const data = await response.json();
                    if (data.success) location.reload();
                    else alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            async togglePasso(id) {
                try {
                    const response = await fetch(`/crm/api/admin/toggle-passo-ativo/${id}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() }
                    });
                    const data = await response.json();
                    if (data.success) location.reload();
                    else alert('‚ùå Erro: ' + (data.error || 'Desconhecido'));
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            },

            getCsrfToken() {
                return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
            }
        }
    }
</script>
{% endblock %}
